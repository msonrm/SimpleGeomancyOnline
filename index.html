<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç∏„Ç™„Éû„É≥„Ç∑„Éº„Éª„ÉØ„É≥„Ç™„É©„ÇØ„É´</title>
    <meta name="description" content="„Ç∑„É≥„Éó„É´„Å™„Ç∏„Ç™„Éû„É≥„Ç∑„ÉºÂç†„ÅÑ„Ç¢„Éó„É™ - „ÉØ„É≥„Ç™„É©„ÇØ„É´„Åß„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèó„ÅëÂèñ„Çç„ÅÜ">
    <meta name="theme-color" content="#2c3e50">
    
    <!-- PWA manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuOCuOOCquODnuODs+OCt+ODvOODu+ODr+ODs+OCquODqeOCr+ODqyIsCiAgInNob3J0X25hbWUiOiAi44K444Kq44Oe44Oz44K344O844AA44Ov44Oz44Kq44Op44Kv44OrIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMmMzZTUwIiwKICAidGhlbWVfY29sb3IiOiAiIzJjM2U1MCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1USTRJaUJvWldsbmFIUTlJakV5T0NJZ2RtbGxkMEp2ZUQwaU1DQXdJREV5T0NBeU9DSWdlRzFzYm5NOUltaDBkSEE2THk5M2QzY3Vkek11YjNKbkx6SXdNREF2YzNabklpQm1hV3hzUFNJalpEVXhaVGhtSWo0S1BHSjFkSFJ2Ym5NZ2RISmhibk5tYjNKdFBTSjBjbUZ1YzJ4aGRHVW9OalFnTmpRcElpQm1hV3hzUFNJalpEVXhaVGhtSWo0S1BISmxZM1FnZUQwaU1UZ2lJSGs5SWpFNElpQjNhV1IwYUQwaU9Ua2lJR2hsYVdkb2REODFNQ0lpSUhKNFBTSTFJaUJtYVd4c1BTSWpNVGMwT0RGaklqNEtQSEpsWTNRZ2VEMGlNVGdpSUhrOUlqYzBJaUIzYVdSMGFEMGlPVGtpSUdobGFXZG9kRDBpTXpZaUlISjRQU0kxSWlCbWFXeHNQU0lqTVRjME9ERmpJajRLUEdOcGNtTnNaU0JqZUQwaU5qa2lJR041UFNJMk9DSWdjajBpT1NJZ1ptbHNiRDBpSTJabU16UXpOQ0krQ2lCOEwzTjJaejQ9IiwKICAgICAgInNpemVzIjogIjEyOHgxMjgiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #e8dcc6 0%, #d4c4a8 100%);
            min-height: 100vh;
            color: #5d4e37;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: none;
            margin: 0;
            padding: 20px 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .oracle-screen .container {
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 28px;
            font-weight: 300;
            color: #5d4e37;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 16px;
            color: rgba(93,78,55,0.8);
            font-weight: 300;
        }

        .oracle-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 40px 0;
        }

        .oracle-button {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 24px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 500;
            color: #5d4e37;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .oracle-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .oracle-button:active {
            transform: translateY(0);
        }

        .oracle-button .emoji {
            font-size: 24px;
            margin-right: 12px;
        }

        .info-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #5d4e37;
            margin-bottom: 12px;
        }

        .info-text {
            font-size: 14px;
            color: rgba(93,78,55,0.8);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .app-link {
            display: inline-block;
            background: #8b7355;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139,115,85,0.3);
        }

        .app-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(139,115,85,0.4);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .back-button {
            background: none;
            border: none;
            color: #5d4e37;
            padding: 8px 0;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 0;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-button:hover {
            color: #8b7355;
        }

        .oracle-screen {
            text-align: center;
        }

        .oracle-title {
            font-size: 24px;
            color: #5d4e37;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .dot-zones {
            display: flex;
            flex-direction: column;
            width: 100%;
            margin: 0;
            border: none;
            border-radius: 0;
            overflow: hidden;
            flex: 1;
        }

        .dot-zone {
            background: rgba(255,255,255,0.6);
            border-bottom: 1px solid rgba(93,78,55,0.3);
            min-height: 100px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            width: 100%;
        }

        .dot-zone:last-child {
            border-bottom: none;
        }

        .dot-zone:hover {
            background: rgba(255,255,255,0.7);
        }

        .dots-display {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 100px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: #8b7355;
            border-radius: 50%;
            position: absolute;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        .zone-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .zone-label {
            position: absolute;
            top: 8px;
            left: 12px;
            font-size: 12px;
            color: rgba(93,78,55,0.6);
            display: none;
        }

        .generate-button {
            background: rgba(93,78,55,0.3);
            border: none;
            color: #5d4e37;
            padding: 16px 32px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 600;
            cursor: not-allowed;
            margin: 20px auto;
            transition: all 0.3s ease;
            opacity: 0.5;
        }

        .generate-button.active {
            background: #8b7355;
            color: white;
            cursor: pointer;
            opacity: 1;
        }

        .generate-button.active:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139,115,85,0.3);
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .dice {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .dice:hover {
            transform: scale(1.1);
        }

        .dice.rolling {
            animation: roll 1s infinite;
        }

        @keyframes roll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }

        .roll-button {
            background: #8b7355;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .roll-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139,115,85,0.3);
        }

        .roll-button:disabled {
            background: rgba(139,115,85,0.3);
            cursor: not-allowed;
            transform: none;
        }

        /* „ÉÄ„Ç§„ÇπÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ */
        .dice-results {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 20px 0;
            padding: 0 20px;
        }

        .dice-result-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .dice-result-box {
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 12px;
            width: 60px;
            height: 60px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dice-result-box.fire {
            border-color: #ffaaaa;
            background: #ffdddd;
        }

        .dice-result-box.air {
            border-color: #ffffaa;
            background: #ffffdd;
        }

        .dice-result-box.water {
            border-color: #aaccff;
            background: #ddeeff;
        }

        .dice-result-box.earth {
            border-color: #aaffaa;
            background: #ddffdd;
        }

        .element-label {
            font-size: 11px;
            color: rgba(93,78,55,0.8);
            font-weight: 600;
        }

        .dice-value {
            font-size: 20px;
            font-weight: bold;
            color: #5d4e37;
        }

        .dice-value.empty {
            color: rgba(93,78,55,0.3);
            font-size: 16px;
        }

        /* „Ç∑„É≥„Éú„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */
        .symbol-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .symbol-dialog.show {
            opacity: 1;
            visibility: visible;
        }

        .symbol-content {
            background: #f5f0e8;
            border: 2px solid #8b7355;
            border-radius: 12px;
            width: calc(100% - 40px);
            max-width: 400px;
            max-height: calc(100% - 80px);
            overflow-y: auto;
            position: relative;
        }

        .symbol-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 0 24px;
            border-bottom: 1px solid rgba(139,115,85,0.2);
            margin-bottom: 20px;
        }

        .symbol-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #5d4e37;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            color: #8b7355;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-button:hover {
            background: rgba(139,115,85,0.1);
            color: #5d4e37;
        }

        .symbol-body {
            padding: 0 24px 24px 24px;
        }

        .symbol-image-area {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
            border: 1px solid rgba(139,115,85,0.2);
        }

        .symbol-image {
            max-width: 100%;
            height: auto;
            max-height: 200px;
        }

        .symbol-placeholder {
            font-size: 48px;
            font-family: monospace;
            color: #5d4e37;
            line-height: 1.2;
            letter-spacing: 4px;
        }

        .symbol-name {
            font-size: 18px;
            font-weight: 600;
            color: #5d4e37;
            text-align: center;
            margin-bottom: 16px;
        }

        .symbol-attributes {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .symbol-attribute {
            background: rgba(139,115,85,0.1);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            color: #5d4e37;
            font-weight: 500;
        }

        .symbol-meaning {
            font-size: 15px;
            color: #5d4e37;
            line-height: 1.6;
            text-align: left;
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
            
            .title {
                font-size: 24px;
            }
            
            .oracle-button {
                padding: 20px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- „É°„Ç§„É≥ÁîªÈù¢ -->
        <div id="home-screen" class="screen active">
            <div class="header">
                <h1 class="title">„Ç∏„Ç™„Éû„É≥„Ç∑„Éº</h1>
            </div>

            <div class="oracle-buttons">
                <button class="oracle-button" onclick="showDotOracle()">
                    <span class="emoji">‚ö´</span>
                    „ÉØ„É≥„Ç™„É©„ÇØ„É´Ôºà„Éâ„ÉÉ„ÉàÔºâ
                </button>
                
                <button class="oracle-button" onclick="showDiceOracle()">
                    <span class="emoji">üé≤</span>
                    „ÉØ„É≥„Ç™„É©„ÇØ„É´Ôºà„ÉÄ„Ç§„ÇπÔºâ
                </button>
            </div>

            <div class="info-section">
                <h3 class="info-title">„Ç∏„Ç™„Éû„É≥„Ç∑„Éº„Å®„ÅØ</h3>
                <p class="info-text">
                    Âè§‰ª£„Åã„Çâ‰ºù„Çè„ÇãÂúüÂç†„ÅÑ„ÄÇ16„ÅÆ„Ç∑„É≥„Éú„É´„Çí‰Ωø„Å£„Å¶„ÄÅ‰ªä„ÅÆ„ÅÇ„Å™„Åü„Å´ÂøÖË¶Å„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèó„ÅëÂèñ„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ„ÉØ„É≥„Ç™„É©„ÇØ„É´„ÅØÊúÄ„ÇÇ„Ç∑„É≥„Éó„É´„Å™Âç†„ÅÑÊñπ„Åß„ÄÅ‰∏Ä„Å§„ÅÆ„Ç∑„É≥„Éú„É´„Åã„Çâ„Ç§„É≥„Çπ„Éî„É¨„Éº„Ç∑„Éß„É≥„ÇíÂæó„Åæ„Åô„ÄÇ
                </p>
                
                <a href="#" class="app-link" onclick="showAppPromo()">
                    üì± Geomancy Diary „Ç¢„Éó„É™
                </a>
            </div>
        </div>

        <!-- „Éâ„ÉÉ„Éà„Ç™„É©„ÇØ„É´ÁîªÈù¢ -->
        <div id="dot-oracle-screen" class="screen">
            <div style="padding: 16px 0 8px 0;">
                <button class="back-button" style="margin-left: 20px;" onclick="showHome()">‚Üê Êàª„Çã</button>
            </div>
            
            <div class="dot-zones">
                <div class="dot-zone" onclick="tapZone(event, 0)" ontouchstart="handleTouch(event, 0)">
                    <div class="dots-display" id="zone-0">
                        <canvas class="zone-canvas" id="canvas-0"></canvas>
                    </div>
                </div>
                <div class="dot-zone" onclick="tapZone(event, 1)" ontouchstart="handleTouch(event, 1)">
                    <div class="dots-display" id="zone-1">
                        <canvas class="zone-canvas" id="canvas-1"></canvas>
                    </div>
                </div>
                <div class="dot-zone" onclick="tapZone(event, 2)" ontouchstart="handleTouch(event, 2)">
                    <div class="dots-display" id="zone-2">
                        <canvas class="zone-canvas" id="canvas-2"></canvas>
                    </div>
                </div>
                <div class="dot-zone" onclick="tapZone(event, 3)" ontouchstart="handleTouch(event, 3)">
                    <div class="dots-display" id="zone-3">
                        <canvas class="zone-canvas" id="canvas-3"></canvas>
                    </div>
                </div>
            </div>
            
            <div style="padding: 16px 20px 20px 20px; text-align: center;">
                <p style="color: rgba(93,78,55,0.7); font-size: 14px; margin-bottom: 16px; line-height: 1.4;">
                    ÂêÑÈ†òÂüü„ÇíÂè≥„Åã„ÇâÂ∑¶„Å´Âêë„Åã„Å£„Å¶„ÄÅÊÄù„ÅÑ„ÅÆ„Åæ„Åæ„Å´Ëá™Áî±„Å™ÂÄãÊï∞„Åß„Éâ„ÉÉ„Éà„ÇíÊâì„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ4„Å§„ÅÆÈ†òÂüü„Åô„Åπ„Å¶„Å´„Éâ„ÉÉ„Éà„ÅåÈÖçÁΩÆ„Åï„Çå„Åü„Çâ„Äå„Ç∑„É≥„Éú„É´„ÇíÁîüÊàê„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Éâ„ÉÉ„Éà„ÅÆÂÅ∂Êï∞„ÉªÂ•áÊï∞„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„Åã„Çâ„Ç∏„Ç™„Éû„É≥„Ç∑„Éº„ÅÆ„Ç∑„É≥„Éú„É´„ÅåÊ±∫„Åæ„Çä„Åæ„Åô„ÄÇ
                </p>
                <button class="generate-button" id="generate-btn" onclick="generateSymbol()">
                    „Ç∑„É≥„Éú„É´„ÇíÁîüÊàê
                </button>
            </div>
        </div>

        <!-- „ÉÄ„Ç§„Çπ„Ç™„É©„ÇØ„É´ÁîªÈù¢ -->
        <div id="dice-oracle-screen" class="screen">
            <div style="padding: 16px 0 8px 0;">
                <button class="back-button" style="margin-left: 20px;" onclick="showHome()">‚Üê Êàª„Çã</button>
            </div>
            
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div id="dice-3d-container" style="width: 100%; aspect-ratio: 1; max-width: 600px; margin: 0 auto; position: relative; background: rgba(255,255,255,0.3); border-radius: 12px;">
                    <!-- Three.js„Ç≠„É£„É≥„Éê„Çπ„Åå„Åì„Åì„Å´ÊåøÂÖ•„Åï„Çå„Åæ„Åô -->
                </div>
                
                <div style="padding: 16px 20px 20px 20px; text-align: center;">
                    <p style="color: rgba(93,78,55,0.7); font-size: 14px; margin-bottom: 16px; line-height: 1.4;">
                        4„Å§„ÅÆ„Ç®„É¨„É°„É≥„ÉàÔºàÁÅ´„ÉªÈ¢®„ÉªÊ∞¥„ÉªÂú∞Ôºâ„ÇíË°®„Åô„ÉÄ„Ç§„ÇπÔºà1„Å®2„ÅÆÁõÆ„ÅÆ„ÅøÔºâ„ÇíÊåØ„Å£„Å¶„ÄÅ„Ç∑„É≥„Éú„É´„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ
                    </p>
                    
                    <!-- „ÉÄ„Ç§„ÇπÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ -->
                    <div class="dice-results">
                        <div class="dice-result-container">
                            <div class="dice-result-box fire">
                                <div class="dice-value empty" id="dice-result-0">?</div>
                            </div>
                            <div class="element-label">ÁÅ´</div>
                        </div>
                        <div class="dice-result-container">
                            <div class="dice-result-box air">
                                <div class="dice-value empty" id="dice-result-1">?</div>
                            </div>
                            <div class="element-label">È¢®</div>
                        </div>
                        <div class="dice-result-container">
                            <div class="dice-result-box water">
                                <div class="dice-value empty" id="dice-result-2">?</div>
                            </div>
                            <div class="element-label">Ê∞¥</div>
                        </div>
                        <div class="dice-result-container">
                            <div class="dice-result-box earth">
                                <div class="dice-value empty" id="dice-result-3">?</div>
                            </div>
                            <div class="element-label">Âú∞</div>
                        </div>
                    </div>
                    
                    <button class="roll-button" id="dice-roll-btn" onclick="initDicePhysics()">„ÉÄ„Ç§„Çπ„ÇíÊåØ„Çã</button>
                </div>
            </div>
        </div>
    </div>

    <!-- „Ç∑„É≥„Éú„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="symbol-dialog" id="symbolDialog">
        <div class="symbol-content">
            <div class="symbol-header">
                <h3>Âç†„ÅÑÁµêÊûú</h3>
                <button class="close-button" onclick="closeSymbolDialog()">√ó</button>
            </div>
            
            <div class="symbol-body">
                <div class="symbol-image-area">
                    <img class="symbol-image" id="symbol-image" src="1212.png" alt="„Ç∑„É≥„Éú„É´">
                </div>
                
                <div class="symbol-name" id="symbol-name">
                    Fortuna MinorÔºàÂ∞èÂêâÔºâ
                </div>
                
                <div class="symbol-attributes">
                    <div class="symbol-attribute" id="symbol-yesno">Yes/No: „Ç§„Ç®„Çπ</div>
                    <div class="symbol-attribute" id="symbol-fortune">ÂêâÂá∂: Â∞èÂêâ</div>
                </div>
                
                <div class="symbol-meaning" id="symbol-meaning">
                    Â∞è„Åï„Åè‰∏ÄÊôÇÁöÑ„Å™Âπ∏ÈÅã„ÄÅ„Åï„Åï„ÇÑ„Åã„Å™Âπ∏„Åõ„ÄÇÂë®„Çä„Åã„Çâ„ÅÆÊè¥Âä©„ÄÇ
                </div>
            </div>
        </div>
    </div>

    <!-- Three.js „Å® Cannon.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.js"></script>

    <script>
        // PWAÁî®„ÅÆ„Çµ„Éº„Éì„Çπ„ÉØ„Éº„Ç´„ÉºÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsKICBldmVudC5yZXNwb25kV2l0aChmZXRjaChldmVudC5yZXF1ZXN0KSk7Cn0pOw==')
                .then(() => console.log('SW registered'))
                .catch(() => console.log('SW registration failed'));
            });
        }

        // „Éâ„ÉÉ„ÉàÂç†„ÅÑÁî®„ÅÆÂ§âÊï∞
        let zoneDots = [[], [], [], []]; // 4„Å§„ÅÆÈ†òÂüü„ÅÆ„Éâ„ÉÉ„ÉàÂ∫ßÊ®ô
        let isGenerating = false; // ÁîüÊàê‰∏≠„Éï„É©„Ç∞

        // 3DÁâ©ÁêÜ„Ç®„É≥„Ç∏„É≥Áî®„ÅÆÂ§âÊï∞
        let scene, camera, renderer, world;
        let animationId;

        // „ÉÄ„Ç§„ÇπÁÆ°ÁêÜÁî®„ÅÆÈÖçÂàó
        let diceObjects = [];
        let diceResults = [];

        // „Ç∏„Ç™„Éû„É≥„Ç∑„Éº„ÅÆ„Ç∑„É≥„Éú„É´ÂÆöÁæ©Ôºà16Á®ÆÈ°ûÔºâ
        const geomancySymbols = {
            '2222': { 
                name: 'PopulusÔºà‰∫∫„ÄÖÔºâ', 
                meaning: 'Áâ©‰∫ã„ÇÑ‰∫∫„ÅåÂ§öÊï∞„ÅÇ„ÇãÁä∂ÊÖã„ÄÇÂèó„ÅëË∫´„ÄÇÂÆâÂÆö„ÄÇ', 
                symbol: '‚Ä¢‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢‚Ä¢',
                yesno: '„Ç§„Ç®„Çπ',
                fortune: 'Âêâ'
            },
            '1111': { 
                name: 'ViaÔºàÈÅìÔºâ', 
                meaning: 'Â§âÂåñ„ÄÅÂãï„Åè„Åì„Å®„ÄÅÈÅéÁ®ã„ÄÇÊ±∫Êñ≠„ÄÇÁ©çÊ•µÊÄß„ÄÅËÉΩÂãïÊÄß„ÄÇ', 
                symbol: '‚Ä¢\n‚Ä¢\n‚Ä¢\n‚Ä¢',
                yesno: '„Éé„Éº',
                fortune: 'Âêâ„Åß„ÇÇÂá∂„Åß„ÇÇ„Å™„ÅÑ„ÄÇÊóÖ„ÇÑÁßªÂãï„Å´„Å§„ÅÑ„Å¶Âêâ'
            },
            '2112': { 
                name: 'ConjunctioÔºà„Å§„Å™„Åå„ÇäÔºâ', 
                meaning: 'ÈÅï„ÅÜËÄÖÂêåÂ£´Áµê„Å≥„Å§„Åè„ÄÅÁõÆÁöÑ„ÇíÊåÅ„Å£„Å¶ÈõÜ„Åæ„Çã„ÄÅÁµÜ„ÅåÁîü„Åæ„Çå„Çã„ÄÇÂ§±„ÅõÁâ©„ÅåË¶ã„Å§„Åã„Çã„ÄÇ', 
                symbol: '‚Ä¢‚Ä¢\n‚Ä¢\n‚Ä¢\n‚Ä¢‚Ä¢',
                yesno: '„Ç§„Ç®„Çπ',
                fortune: 'Âêâ„Å®Âá∂„ÅÆ‰∏°Êñπ'
            },
            '1221': { 
                name: 'CarcerÔºàÊãòÊùüÔºâ', 
                meaning: 'Â≠§Áã¨„ÄÅË∫´Âãï„Åç„ÅåÂèñ„Çå„Å™„ÅÑ„ÄÅ„Å≤„Åç„Åì„ÇÇ„Çä„ÄÇÂÅúÊªû„ÄÅÁèæÁä∂Á∂≠ÊåÅ„ÄÇ', 
                symbol: '‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢',
                yesno: '„Éé„Éº',
                fortune: 'Âá∂„ÄÇ„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Å´Èñ¢„Åó„Å¶„ÅØÂêâ'
            },
            '2211': { 
                name: 'Fortuna MajorÔºàÂ§ßÂêâÔºâ', 
                meaning: 'Â§ß„Åç„Å™Âπ∏ÈÅã„ÄÇËá™ÂàÜ„ÅÆÊÄù„ÅÑÈÄö„Çä„Å´„Åì„Å®„ÅåÈÅã„Å∂„ÄÇ', 
                symbol: '‚Ä¢‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢\n‚Ä¢',
                yesno: '„Ç§„Ç®„Çπ',
                fortune: 'Â§ßÂêâ'
            },
            '1122': { 
                name: 'Fortuna MinorÔºàÂ∞èÂêâÔºâ', 
                meaning: 'Â∞è„Åï„Åè‰∏ÄÊôÇÁöÑ„Å™Âπ∏ÈÅã„ÄÅ„Åï„Åï„ÇÑ„Åã„Å™Âπ∏„Åõ„ÄÇÂë®„Çä„Åã„Çâ„ÅÆÊè¥Âä©„ÄÇ', 
                symbol: '‚Ä¢\n‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢‚Ä¢',
                yesno: '„Ç§„Ç®„Çπ',
                fortune: 'Â∞èÂêâ'
            },
            '2121': { 
                name: 'AcquisitioÔºàÁç≤ÂæóÔºâ', 
                meaning: 'ÂèéÁ©´„ÄÅÂà©Áõä„ÄÇÈ°ò„ÅÑ„ÅåÂè∂„ÅÜ„ÄÇ‰Ωï„Åã„ÇíÂèó„ÅëÂèñ„Çã„ÄÅÂèó„ÅëÂÖ•„Çå„Çã„ÄÇ', 
                symbol: '‚Ä¢‚Ä¢\n‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢',
                yesno: '„Ç§„Ç®„Çπ',
                fortune: 'Âêâ'
            },
            '1212': { 
                name: 'AmissioÔºàÂñ™Â§±Ôºâ', 
                meaning: 'ÊêçÂ§±„ÄÅÊÑõÊÉÖ„ÇÑÈáëÈä≠„Å™„Å©„ÇíÂ§±„ÅÜ„ÄÇÁóÖÊ∞ó„ÇÑ„Éà„É©„Éñ„É´„ÄÅÊÇ™Áôñ„Åå„Å™„Åè„Å™„Çã„ÄÇ', 
                symbol: '‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢\n‚Ä¢‚Ä¢',
                yesno: '„Éé„Éº',
                fortune: 'Âá∂'
            },
            '1222': { 
                name: 'LaetitiaÔºàÂñú„Å≥Ôºâ', 
                meaning: 'Âñú„Å∞„Åó„ÅÑ„Åì„Å®„ÄÅÁ¨ë„ÅÑ„ÄÅÊàêÂäü„ÄÇÈü≥Ê•Ω„ÇÑË∏ä„Çä„ÄÇÈ´≠„ÅÆ„ÅÇ„ÇãÁî∑ÊÄß„ÄÇ', 
                symbol: '‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢‚Ä¢',
                yesno: '„Ç§„Ç®„Çπ',
                fortune: 'Âêâ'
            },
            '2221': { 
                name: 'TristitiaÔºàÊÇ≤„Åó„ÅøÔºâ', 
                meaning: '‰∏çÂπ∏„ÄÅÂèóÈõ£„ÄÅÂÆøÂëΩ„ÄÇ', 
                symbol: '‚Ä¢‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢',
                yesno: '„Éé„Éº',
                fortune: 'Âá∂„ÄÇÂç†„ÅÑ„ÇÑÈ≠îË°ì„Å´Èñ¢„Åó„Å¶„ÅØÂêâ'
            },
            '1211': { 
                name: 'PuellaÔºàÂ∞ëÂ•≥Ôºâ', 
                meaning: 'Â•≥ÊÄß„Çâ„Åó„Åï„ÄÅÁæé„Åó„Åï„ÄÇ„Å®„Åç„ÇÅ„Åç„ÄÅÂ¨â„Åó„Åï„ÄÇÁõÆÂÖà„ÅÆÊ•Ω„Åó„Åø„ÄÇ', 
                symbol: '‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢\n‚Ä¢',
                yesno: '„Ç§„Ç®„Çπ',
                fortune: 'Âêâ'
            },
            '1121': { 
                name: 'PuerÔºàÂ∞ëÂπ¥Ôºâ', 
                meaning: 'Áî∑ÊÄß„Çâ„Åó„Åï„ÄÅÂäõÂº∑„Åï„ÄÅÊú™ÁÜü„Åï„ÄÇÊú™Êù•„ÇíÂàá„ÇäÈñã„Åè„ÄÇ', 
                symbol: '‚Ä¢\n‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢',
                yesno: '„Éé„Éº',
                fortune: 'Âá∂„ÄÇ‰∫â„ÅÑ‰∫ã„Å´„ÅØÂêâ'
            },
            '2212': { 
                name: 'AlbusÔºàÁôΩÔºâ', 
                meaning: 'ÂÖ¨Ê≠£„ÄÅÈ´òÊΩî„Åï„ÄÅÊ≠£Áæ©„ÄÇÁâáÊÄù„ÅÑ„ÇÑ„Éó„É©„Éà„Éã„ÉÉ„ÇØ„Éª„É©„Éñ„ÄÇ', 
                symbol: '‚Ä¢‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢\n‚Ä¢‚Ä¢',
                yesno: '„Ç§„Ç®„Çπ',
                fortune: 'Âêâ'
            },
            '2122': { 
                name: 'RubeusÔºàËµ§Ôºâ', 
                meaning: '‰∫â„ÅÑ‰∫ã„ÄÅÈóò‰∫âÂøÉ„ÄÇÊÇ™„ÅÑ„Åì„Å®„Å´„ÅØÂêâ„ÄÅËâØ„ÅÑ„Åì„Å®„Å´„ÅØÂá∂„ÄÇ', 
                symbol: '‚Ä¢‚Ä¢\n‚Ä¢\n‚Ä¢‚Ä¢\n‚Ä¢‚Ä¢',
                yesno: '„Éé„Éº',
                fortune: 'Âá∂'
            },
            '2111': { 
                name: 'Caput DraconisÔºàÁ´ú„ÅÆÈ†≠Ôºâ', 
                meaning: 'Âßã„Åæ„Çä„ÄÅÊñ∞„Åó„ÅÑÊââ„ÅåÈñã„Åè„ÄÅÂâç‰æã„ÅÆ„Å™„ÅÑË™≤È°å„Å´Âèñ„ÇäÁµÑ„ÇÄ„ÄÇ„ÇÑ„Çä„Åô„Åé„ÅÆÂÇæÂêë„ÄÇ', 
                symbol: '‚Ä¢‚Ä¢\n‚Ä¢\n‚Ä¢\n‚Ä¢',
                yesno: '„Ç§„Ç®„Çπ',
                fortune: 'ÂêâÂá∂ÂÖ•„ÇäÊ∑∑„Åò„Çã„ÄÇ‰Ωï„Åã„ÇíÂßã„ÇÅ„Çã„Å´„ÅØÂêâ'
            },
            '1112': { 
                name: 'Cauda DraconisÔºàÁ´ú„ÅÆÂ∞æÔºâ', 
                meaning: 'ÁµÇ„Çè„Çä„ÄÅÁâ©‰∫ã„ÅÆÂÆåÊàê„ÄÅÈÄîÁµ∂„ÄÇÂêâ„ÅØÂá∂„Å®„Å™„Çä„ÄÅÂá∂„ÅØÂêâ„Å®„Å™„Çã„ÄÇ', 
                symbol: '‚Ä¢\n‚Ä¢\n‚Ä¢\n‚Ä¢‚Ä¢',
                yesno: '„Éé„Éº',
                fortune: 'Âêâ„Åß„ÇÇÂá∂„Åß„ÇÇ„Å™„ÅÑ„ÄÇ‰Ωï„Åã„ÇíÁµÇ„Çè„Çâ„Åõ„Çã„Å´„ÅØÂêâ'
            }
        };

        function showDotOracle() {
            hideAllScreens();
            document.getElementById('dot-oracle-screen').classList.add('active');
            resetDotOracle();
        }

        function showDiceOracle() {
            hideAllScreens();
            document.getElementById('dice-oracle-screen').classList.add('active');
            
            setTimeout(() => {
                init3DScene();
            }, 100);
        }

        function showHome() {
            hideAllScreens();
            document.getElementById('home-screen').classList.add('active');
        }

        function hideAllScreens() {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.remove('active'));
        }

        function resetDotOracle() {
            zoneDots = [[], [], [], []];
            for (let i = 0; i < 4; i++) {
                const zoneElement = document.getElementById(`zone-${i}`);
                const dots = zoneElement.querySelectorAll('.dot');
                dots.forEach(dot => dot.remove());
                
                const canvas = document.getElementById(`canvas-${i}`);
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            updateGenerateButton();
        }

        function tapZone(event, zoneIndex) {
            event.preventDefault();
            event.stopPropagation();
            
            const zoneElement = document.getElementById(`zone-${zoneIndex}`);
            const rect = zoneElement.getBoundingClientRect();
            
            const x = ((event.clientX - rect.left) / rect.width) * 100;
            const y = ((event.clientY - rect.top) / rect.height) * 100;
            
            addDot(zoneIndex, x, y);
        }

        function handleTouch(event, zoneIndex) {
            event.preventDefault();
            event.stopPropagation();
            
            if (event.touches && event.touches.length > 0) {
                const touch = event.touches[0];
                const zoneElement = document.getElementById(`zone-${zoneIndex}`);
                const rect = zoneElement.getBoundingClientRect();
                
                const x = ((touch.clientX - rect.left) / rect.width) * 100;
                const y = ((touch.clientY - rect.top) / rect.height) * 100;
                
                addDot(zoneIndex, x, y);
            }
        }

        function addDot(zoneIndex, x, y) {
            if (isGenerating) return;
            
            if (x < 0 || x > 100 || y < 0 || y > 100) return;
            
            zoneDots[zoneIndex].push({ x, y });
            
            const zoneElement = document.getElementById(`zone-${zoneIndex}`);
            const dot = document.createElement('div');
            dot.className = 'dot';
            dot.style.left = `${x}%`;
            dot.style.top = `${y}%`;
            zoneElement.appendChild(dot);
            
            const canvas = document.getElementById(`canvas-${zoneIndex}`);
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            updateGenerateButton();
        }

        function updateGenerateButton() {
            if (isGenerating) return;
            
            const generateBtn = document.getElementById('generate-btn');
            const allZonesHaveDots = zoneDots.every(zone => zone.length > 0);
            
            if (allZonesHaveDots) {
                generateBtn.classList.add('active');
            } else {
                generateBtn.classList.remove('active');
            }
        }

        function generateSymbol() {
            const generateBtn = document.getElementById('generate-btn');
            if (!generateBtn.classList.contains('active') || isGenerating) return;
            
            isGenerating = true;
            generateBtn.classList.remove('active');
            generateBtn.textContent = 'ÁîüÊàê‰∏≠...';
            
            for (let i = 0; i < 4; i++) {
                animatePairing(i);
            }
            
            setTimeout(() => {
                showSymbolDialog();
            }, 2000);
        }

        function showSymbolDialog() {
            const pattern = zoneDots.map(zone => {
                return zone.length % 2 === 0 ? '2' : '1';
            }).join('');
            
            let symbol = geomancySymbols[pattern];
            if (!symbol) {
                const keys = Object.keys(geomancySymbols);
                symbol = geomancySymbols[keys[0]];
            }
            
            document.getElementById('symbol-image').src = `${pattern}.png`;
            document.getElementById('symbol-name').textContent = symbol.name;
            document.getElementById('symbol-yesno').textContent = `Yes/No: ${symbol.yesno}`;
            document.getElementById('symbol-fortune').textContent = `ÂêâÂá∂: ${symbol.fortune}`;
            document.getElementById('symbol-meaning').textContent = symbol.meaning;
            
            document.getElementById('symbolDialog').classList.add('show');
        }

        function closeSymbolDialog() {
            document.getElementById('symbolDialog').classList.remove('show');
            
            setTimeout(() => {
                resetDotOracle();
                isGenerating = false;
                document.getElementById('generate-btn').textContent = '„Ç∑„É≥„Éú„É´„ÇíÁîüÊàê';
            }, 300);
        }

        function animatePairing(zoneIndex) {
            const zoneElement = document.getElementById(`zone-${zoneIndex}`);
            const canvas = document.getElementById(`canvas-${zoneIndex}`);
            const ctx = canvas.getContext('2d');
            const dots = zoneElement.querySelectorAll('.dot');
            const dotCoords = zoneDots[zoneIndex];
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            for (let i = 0; i < dots.length; i += 2) {
                setTimeout(() => {
                    if (i + 1 < dots.length) {
                        const x1 = (dotCoords[i].x / 100) * canvas.width;
                        const y1 = (dotCoords[i].y / 100) * canvas.height;
                        const x2 = (dotCoords[i + 1].x / 100) * canvas.width;
                        const y2 = (dotCoords[i + 1].y / 100) * canvas.height;
                        
                        ctx.strokeStyle = '#8b7355';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.stroke();
                    }
                }, i * 100);
            }
        }

        function init3DScene() {
            const container = document.getElementById('dice-3d-container');
            if (!container) {
                return;
            }

            const existingCanvas = container.querySelector('canvas');
            if (existingCanvas) {
                existingCanvas.remove();
            }

            if (!window.THREE || !window.CANNON) {
                return;
            }

            try {
                const width = container.clientWidth;
                const height = container.clientHeight;

                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf0f0f0);

                camera = new THREE.OrthographicCamera(
                    -10, 10, 10, -10, 0.1, 100
                );
                camera.position.set(0, 20, 0);
                camera.lookAt(0, 0, 0);

                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(width, height);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                renderer.domElement.style.borderRadius = '12px';
                container.appendChild(renderer.domElement);

                const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
                directionalLight.position.set(-8, 18, -5);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                directionalLight.shadow.camera.left = -15;
                directionalLight.shadow.camera.right = 15;
                directionalLight.shadow.camera.top = 15;
                directionalLight.shadow.camera.bottom = -15;
                directionalLight.shadow.radius = 12;
                scene.add(directionalLight);

                world = new CANNON.World();
                world.gravity.set(0, -6.5, 0);
                world.broadphase = new CANNON.NaiveBroadphase();
                
                const diceMaterial = new CANNON.Material('dice');
                const floorMaterial = new CANNON.Material('floor');
                
                const diceDiceContact = new CANNON.ContactMaterial(
                    diceMaterial,
                    diceMaterial,
                    {
                        friction: 0.1,
                        restitution: 1.2
                    }
                );
                world.addContactMaterial(diceDiceContact);
                
                const floorDiceContact = new CANNON.ContactMaterial(
                    floorMaterial,
                    diceMaterial,
                    {
                        friction: 0.4,
                        restitution: 0.3
                    }
                );
                world.addContactMaterial(floorDiceContact);

                createFloor();
                createWalls();
                animate3D();

            } catch (error) {
                console.error('3D„Ç∑„Éº„É≥ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
        }

        function createFloor() {
            const floorMaterial = new CANNON.Material('floor');
            const floorShape = new CANNON.Plane();
            const floorBody = new CANNON.Body({ 
                mass: 0,
                material: floorMaterial
            });
            floorBody.addShape(floorShape);
            floorBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
            world.add(floorBody);

            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterialThree = new THREE.MeshLambertMaterial({ 
                color: 0xe8dcc6, 
                transparent: true, 
                opacity: 0.8 
            });
            const floorMesh = new THREE.Mesh(floorGeometry, floorMaterialThree);
            floorMesh.rotation.x = -Math.PI / 2;
            floorMesh.receiveShadow = true;
            scene.add(floorMesh);
        }

        function createWalls() {
            const wallHeight = 12;
            const roomSize = 12;
            
            const wallPositions = [
                { x: roomSize, y: wallHeight/2, z: 0, rotY: 0 },
                { x: -roomSize, y: wallHeight/2, z: 0, rotY: 0 },
                { x: 0, y: wallHeight/2, z: roomSize, rotY: Math.PI/2 },
                { x: 0, y: wallHeight/2, z: -roomSize, rotY: Math.PI/2 }
            ];

            wallPositions.forEach((pos, index) => {
                const wallShape = new CANNON.Box(new CANNON.Vec3(0.5, wallHeight/2, roomSize));
                const wallBody = new CANNON.Body({ mass: 0 });
                wallBody.addShape(wallShape);
                wallBody.position.set(pos.x, pos.y, pos.z);
                if (pos.rotY) {
                    wallBody.quaternion.setFromAxisAngle(new CANNON.Vec3(0, 1, 0), pos.rotY);
                }
                world.add(wallBody);

                const wallGeometry = new THREE.BoxGeometry(1, wallHeight, roomSize * 2);
                const wallMaterialThree = new THREE.MeshLambertMaterial({ 
                    color: 0xd4c4a8, 
                    transparent: true, 
                    opacity: 0,
                    visible: false
                });
                const wallMesh = new THREE.Mesh(wallGeometry, wallMaterialThree);
                wallMesh.position.set(pos.x, pos.y, pos.z);
                if (pos.rotY) {
                    wallMesh.rotation.y = pos.rotY;
                }
                wallMesh.castShadow = false;
                wallMesh.receiveShadow = false;
                scene.add(wallMesh);
            });
        }

        function animate3D() {
            animationId = requestAnimationFrame(animate3D);
            
            if (world) {
                world.step(1/60);
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        function initDicePhysics() {
            if (!world || !scene) {
                return;
            }
            
            createGeomancyDice();
        }

        function createRoundedBoxGeometry(width, height, depth, radius, smoothness) {
            const shape = new THREE.Shape();
            const eps = 0.00001;
            const radius0 = radius - eps;
            
            shape.absarc(eps, eps, eps, -Math.PI / 2, -Math.PI, true);
            shape.absarc(eps, height - radius * 2, eps, Math.PI, Math.PI / 2, true);
            shape.absarc(width - radius * 2, height - radius * 2, eps, Math.PI / 2, 0, true);
            shape.absarc(width - radius * 2, eps, eps, 0, -Math.PI / 2, true);
            
            const geometry = new THREE.ExtrudeGeometry(shape, {
                depth: depth - radius * 2,
                bevelEnabled: true,
                bevelSegments: smoothness,
                steps: 1,
                bevelSize: radius0,
                bevelThickness: radius,
                curveSegments: smoothness
            });
            
            geometry.center();
            return geometry;
        }

        function createGeomancyDice() {
            clearDice();
            resetDiceResults();
            
            const elements = ['fire', 'air', 'water', 'earth'];
            for (let i = 0; i < 4; i++) {
                const dice = createSingleDice(i, elements[i]);
                diceObjects.push(dice);
            }
            
            checkDiceSettled();
        }

        function createSingleDice(index, element) {
            const positions = [
                [-3, 15, -3],
                [3, 16, -3],
                [-3, 17, 3],
                [3, 18, 3]
            ];
            const pos = positions[index];
            
            const diceShape = new CANNON.Box(new CANNON.Vec3(1.5, 1.5, 1.5));
            const diceMaterial = new CANNON.Material('dice');
            const diceBody = new CANNON.Body({ 
                mass: 1,
                material: diceMaterial,
                linearDamping: 0.1,
                angularDamping: 0.1
            });
            diceBody.addShape(diceShape);
            diceBody.position.set(pos[0], pos[1], pos[2]);
            
            diceBody.angularVelocity.set(
                (Math.random() - 0.5) * 10,
                (Math.random() - 0.5) * 10,
                (Math.random() - 0.5) * 10
            );
            
            world.add(diceBody);

            const colors = {
                fire: 0xffcccc,
                air: 0xffffcc,
                water: 0xccddff,
                earth: 0xccffcc
            };

            const diceGeometry = createRoundedBoxGeometry(3.0, 3.0, 3.0, 0.3, 8);
            const diceMaterialThree = new THREE.MeshLambertMaterial({ color: colors[element] });
            const diceMesh = new THREE.Mesh(diceGeometry, diceMaterialThree);
            diceMesh.castShadow = true;
            diceMesh.receiveShadow = true;
            scene.add(diceMesh);

            createDiceDots(diceMesh);

            const diceObject = {
                body: diceBody,
                mesh: diceMesh,
                id: index,
                element: element
            };

            function updateDice() {
                if (diceBody && diceMesh) {
                    diceMesh.position.copy(diceBody.position);
                    diceMesh.quaternion.copy(diceBody.quaternion);
                }
            }

            const originalAnimate = animate3D;
            animate3D = function() {
                originalAnimate();
                updateDice();
            };

            return diceObject;
        }

        function createDiceDots(diceMesh) {
            const dotGeometry = new THREE.CircleGeometry(0.24, 16);
            const dotMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x333333,
                side: THREE.DoubleSide
            });

            const faceValues = [
                1, 2, 1, 2, 1, 2
            ];
            
            diceMesh.userData.faceValues = faceValues;

            const faces = [
                { normal: [1, 0, 0], center: [1.51, 0, 0], rotation: [0, Math.PI/2, 0], index: 0 },
                { normal: [-1, 0, 0], center: [-1.51, 0, 0], rotation: [0, -Math.PI/2, 0], index: 1 },
                { normal: [0, 1, 0], center: [0, 1.51, 0], rotation: [-Math.PI/2, 0, 0], index: 2 },
                { normal: [0, -1, 0], center: [0, -1.51, 0], rotation: [Math.PI/2, 0, 0], index: 3 },
                { normal: [0, 0, 1], center: [0, 0, 1.51], rotation: [0, 0, 0], index: 4 },
                { normal: [0, 0, -1], center: [0, 0, -1.51], rotation: [0, Math.PI, 0], index: 5 }
            ];

            faces.forEach((face) => {
                const dotCount = faceValues[face.index];
                
                if (dotCount === 1) {
                    const dot = new THREE.Mesh(dotGeometry, dotMaterial);
                    dot.position.set(face.center[0], face.center[1], face.center[2]);
                    dot.rotation.set(face.rotation[0], face.rotation[1], face.rotation[2]);
                    diceMesh.add(dot);
                } else {
                    const positions = [
                        [face.center[0] - 0.6, face.center[1] - 0.6, face.center[2]],
                        [face.center[0] + 0.6, face.center[1] + 0.6, face.center[2]]
                    ];
                    
                    if (face.normal[0] !== 0) {
                        positions[0] = [face.center[0], face.center[1] - 0.6, face.center[2] - 0.6];
                        positions[1] = [face.center[0], face.center[1] + 0.6, face.center[2] + 0.6];
                    } else if (face.normal[1] !== 0) {
                        positions[0] = [face.center[0] - 0.6, face.center[1], face.center[2] - 0.6];
                        positions[1] = [face.center[0] + 0.6, face.center[1], face.center[2] + 0.6];
                    }
                    
                    positions.forEach(pos => {
                        const dot = new THREE.Mesh(dotGeometry, dotMaterial);
                        dot.position.set(pos[0], pos[1], pos[2]);
                        dot.rotation.set(face.rotation[0], face.rotation[1], face.rotation[2]);
                        diceMesh.add(dot);
                    });
                }
            });
        }

        function clearDice() {
            diceObjects.forEach(dice => {
                if (dice.body) {
                    world.remove(dice.body);
                }
                if (dice.mesh) {
                    scene.remove(dice.mesh);
                }
            });
            diceObjects = [];
            diceResults = [];
        }

        function resetDiceResults() {
            for (let i = 0; i < 4; i++) {
                const resultElement = document.getElementById(`dice-result-${i}`);
                resultElement.textContent = '?';
                resultElement.classList.add('empty');
            }
        }

        function updateDiceResult(index, value) {
            const resultElement = document.getElementById(`dice-result-${index}`);
            resultElement.textContent = value;
            resultElement.classList.remove('empty');
        }

        function checkDiceSettled() {
            const checkInterval = setInterval(() => {
                let allSettled = true;
                
                diceObjects.forEach(dice => {
                    const velocity = dice.body.velocity.length();
                    const angularVelocity = dice.body.angularVelocity.length();
                    
                    if (velocity > 0.01 || angularVelocity > 0.01) {
                        allSettled = false;
                    }
                });
                
                if (allSettled) {
                    clearInterval(checkInterval);
                    setTimeout(() => {
                        calculateDiceResults();
                    }, 500);
                }
            }, 100);
        }

        function calculateDiceResults() {
            diceResults = [];
            
            diceObjects.forEach((dice, index) => {
                const upVector = new THREE.Vector3(0, 1, 0);
                
                const faceNormals = [
                    new THREE.Vector3(1, 0, 0),
                    new THREE.Vector3(-1, 0, 0),
                    new THREE.Vector3(0, 1, 0),
                    new THREE.Vector3(0, -1, 0),
                    new THREE.Vector3(0, 0, 1),
                    new THREE.Vector3(0, 0, -1)
                ];
                
                let maxDot = -1;
                let topFaceIndex = 0;
                
                faceNormals.forEach((faceNormal, faceIndex) => {
                    const rotatedNormal = faceNormal.clone();
                    rotatedNormal.applyQuaternion(dice.mesh.quaternion);
                    
                    const dot = upVector.dot(rotatedNormal);
                    
                    if (dot > maxDot) {
                        maxDot = dot;
                        topFaceIndex = faceIndex;
                    }
                });
                
                const result = dice.mesh.userData.faceValues[topFaceIndex];
                diceResults.push(result);
                
                updateDiceResult(index, result);
            });
            
            setTimeout(() => {
                generateSymbolFromDice();
            }, 1500);
        }

        function generateSymbolFromDice() {
            if (diceResults.length !== 4) {
                return;
            }
            
            const pattern = diceResults.join('');
            
            let symbol = geomancySymbols[pattern];
            if (!symbol) {
                const keys = Object.keys(geomancySymbols);
                symbol = geomancySymbols[keys[0]];
            }
            
            document.getElementById('symbol-image').src = `${pattern}.png`;
            document.getElementById('symbol-name').textContent = symbol.name;
            document.getElementById('symbol-yesno').textContent = `Yes/No: ${symbol.yesno}`;
            document.getElementById('symbol-fortune').textContent = `ÂêâÂá∂: ${symbol.fortune}`;
            document.getElementById('symbol-meaning').textContent = symbol.meaning;
            
            document.getElementById('symbolDialog').classList.add('show');
        }

        function showAppPromo() {
            alert('Geomancy Diary „Ç¢„Éó„É™„ÅÆË©≥Á¥∞„Éö„Éº„Ç∏„Å∏ÁßªÂãï„Åó„Åæ„Åô\nÔºàÂÆüË£Ö‰∫àÂÆöÔºâ');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('symbolDialog').addEventListener('click', (e) => {
                if (e.target.id === 'symbolDialog') {
                    closeSymbolDialog();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (document.getElementById('symbolDialog').classList.contains('show')) {
                        closeSymbolDialog();
                    }
                }
            });
        });

        document.addEventListener('touchstart', function() {}, {passive: true});
    </script>
</body>
</html>
