<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¸ã‚ªãƒãƒ³ã‚·ãƒ¼ãƒ»ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ«</title>
    <meta name="description" content="ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¸ã‚ªãƒãƒ³ã‚·ãƒ¼å ã„ã‚¢ãƒ—ãƒª - ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ«ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚ã†">
    <meta name="theme-color" content="#2c3e50">
    
    <!-- PWA manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuOCuOOCquODnuODs+OCt+ODvOODu+ODr+ODs+OCquODqeOCr+ODqyIsCiAgInNob3J0X25hbWUiOiAi44K444Kq44Oe44Oz44K344O844AA44Ov44Oz44Kq44Op44Kv44OrIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMmMzZTUwIiwKICAidGhlbWVfY29sb3IiOiAiIzJjM2U1MCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1USTRJaUJvWldsbmFIUTlJakV5T0NJZ2RtbGxkMEp2ZUQwaU1DQXdJREV5T0NBeU9DSWdlRzFzYm5NOUltaDBkSEE2THk5M2QzY3Vkek11YjNKbkx6SXdNREF2YzNabklpQm1hV3hzUFNJalpEVXhaVGhtSWo0S1BHSjFkSFJ2Ym5NZ2RISmhibk5tYjNKdFBTSjBjbUZ1YzJ4aGRHVW9OalFnTmpRcElpQm1hV3hzUFNJalpEVXhaVGhtSWo0S1BISmxZM1FnZUQwaU1UZ2lJSGs5SWpFNElpQjNhV1IwYUQwaU9Ua2lJR2hsYVdkb2REODFNQ0lpSUhKNFBTSTFJaUJtYVd4c1BTSWpNVGMwT0RGaklqNEtQSEpsWTNRZ2VEMGlNVGdpSUhrOUlqYzBJaUIzYVdSMGFEMGlPVGtpSUdobGFXZG9kRDBpTXpZaUlISjRQU0kxSWlCbWFXeHNQU0lqTVRjME9ERmpJajRLUEdOcGNtTnNaU0JqZUQwaU5qa2lJR041UFNJMk9DSWdjajBpT1NJZ1ptbHNiRDBpSTJabU16UXpOQ0krQ2lCOEwzTjJaejQ9IiwKICAgICAgInNpemVzIjogIjEyOHgxMjgiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #e8dcc6 0%, #d4c4a8 100%);
            min-height: 100vh;
            color: #5d4e37;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: none;
            margin: 0;
            padding: 20px 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .oracle-screen .container {
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 28px;
            font-weight: 300;
            color: #5d4e37;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 16px;
            color: rgba(93,78,55,0.8);
            font-weight: 300;
        }

        .oracle-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 40px 0;
        }

        .oracle-button {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 24px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 500;
            color: #5d4e37;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .oracle-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .oracle-button:active {
            transform: translateY(0);
        }

        .oracle-button .emoji {
            font-size: 24px;
            margin-right: 12px;
        }

        .info-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #5d4e37;
            margin-bottom: 12px;
        }

        .info-text {
            font-size: 14px;
            color: rgba(93,78,55,0.8);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .app-link {
            display: inline-block;
            background: #8b7355;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139,115,85,0.3);
        }

        .app-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(139,115,85,0.4);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .back-button {
            background: none;
            border: none;
            color: #5d4e37;
            padding: 8px 0;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 0;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-button:hover {
            color: #8b7355;
        }

        .oracle-screen {
            text-align: center;
        }

        .oracle-title {
            font-size: 24px;
            color: #5d4e37;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .dot-zones {
            display: flex;
            flex-direction: column;
            width: 100%;
            margin: 0;
            border: none;
            border-radius: 0;
            overflow: hidden;
            flex: 1;
        }

        .dot-zone {
            background: rgba(255,255,255,0.6);
            border-bottom: 1px solid rgba(93,78,55,0.3);
            min-height: 100px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            width: 100%;
        }

        .dot-zone:last-child {
            border-bottom: none;
        }

        .dot-zone:hover {
            background: rgba(255,255,255,0.7);
        }

        .dots-display {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 100px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: #8b7355;
            border-radius: 50%;
            position: absolute;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        .zone-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .zone-label {
            position: absolute;
            top: 8px;
            left: 12px;
            font-size: 12px;
            color: rgba(93,78,55,0.6);
            display: none;
        }

        .generate-button {
            background: rgba(93,78,55,0.3);
            border: none;
            color: #5d4e37;
            padding: 16px 32px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 600;
            cursor: not-allowed;
            margin: 20px auto;
            transition: all 0.3s ease;
            opacity: 0.5;
        }

        .generate-button.active {
            background: #8b7355;
            color: white;
            cursor: pointer;
            opacity: 1;
        }

        .generate-button.active:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139,115,85,0.3);
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .dice {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .dice:hover {
            transform: scale(1.1);
        }

        .dice.rolling {
            animation: roll 1s infinite;
        }

        @keyframes roll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }

        .roll-button {
            background: #8b7355;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .roll-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139,115,85,0.3);
        }

        .roll-button:disabled {
            background: rgba(139,115,85,0.3);
            cursor: not-allowed;
            transform: none;
        }

        /* Three.jsç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #dice-canvas {
            border-radius: 12px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
            
            .title {
                font-size: 24px;
            }
            
            .oracle-button {
                padding: 20px;
                font-size: 16px;
            }
        }

        /* ã‚·ãƒ³ãƒœãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
        .symbol-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .symbol-dialog.show {
            opacity: 1;
            visibility: visible;
        }

        .symbol-content {
            background: #f5f0e8;
            border: 2px solid #8b7355;
            border-radius: 12px;
            width: calc(100% - 40px);
            max-width: 400px;
            max-height: calc(100% - 80px);
            overflow-y: auto;
            position: relative;
        }

        .symbol-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 0 24px;
            border-bottom: 1px solid rgba(139,115,85,0.2);
            margin-bottom: 20px;
        }

        .symbol-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #5d4e37;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            color: #8b7355;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-button:hover {
            background: rgba(139,115,85,0.1);
            color: #5d4e37;
        }

        .symbol-body {
            padding: 0 24px 24px 24px;
        }

        .symbol-image-area {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
            border: 1px solid rgba(139,115,85,0.2);
        }

        .symbol-placeholder {
            font-size: 48px;
            font-family: monospace;
            color: #5d4e37;
            line-height: 1.2;
            letter-spacing: 4px;
        }

        .symbol-name {
            font-size: 18px;
            font-weight: 600;
            color: #5d4e37;
            text-align: center;
            margin-bottom: 16px;
        }

        .symbol-meaning {
            font-size: 15px;
            color: #5d4e37;
            line-height: 1.6;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
        <div id="home-screen" class="screen active">
            <div class="header">
                <h1 class="title">ã‚¸ã‚ªãƒãƒ³ã‚·ãƒ¼</h1>
            </div>

            <div class="oracle-buttons">
                <button class="oracle-button" onclick="showDotOracle()">
                    <span class="emoji">âš«</span>
                    ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ«ï¼ˆãƒ‰ãƒƒãƒˆï¼‰
                </button>
                
                <button class="oracle-button" onclick="showDiceOracle()">
                    <span class="emoji">ğŸ²</span>
                    ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ«ï¼ˆãƒ€ã‚¤ã‚¹ï¼‰
                </button>
            </div>

            <div class="info-section">
                <h3 class="info-title">ã‚¸ã‚ªãƒãƒ³ã‚·ãƒ¼ã¨ã¯</h3>
                <p class="info-text">
                    å¤ä»£ã‹ã‚‰ä¼ã‚ã‚‹åœŸå ã„ã€‚16ã®ã‚·ãƒ³ãƒœãƒ«ã‚’ä½¿ã£ã¦ã€ä»Šã®ã‚ãªãŸã«å¿…è¦ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ«ã¯æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªå ã„æ–¹ã§ã€ä¸€ã¤ã®ã‚·ãƒ³ãƒœãƒ«ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¾—ã¾ã™ã€‚
                </p>
                
                <a href="#" class="app-link" onclick="showAppPromo()">
                    ğŸ“± Geomancy Diary ã‚¢ãƒ—ãƒª
                </a>
            </div>
        </div>

        <!-- ãƒ‰ãƒƒãƒˆã‚ªãƒ©ã‚¯ãƒ«ç”»é¢ -->
        <div id="dot-oracle-screen" class="screen">
            <div style="padding: 16px 0 8px 0;">
                <button class="back-button" style="margin-left: 20px;" onclick="showHome()">â† æˆ»ã‚‹</button>
            </div>
            
            <div class="dot-zones">
                <div class="dot-zone" onclick="tapZone(event, 0)" ontouchstart="handleTouch(event, 0)">
                    <div class="dots-display" id="zone-0">
                        <canvas class="zone-canvas" id="canvas-0"></canvas>
                    </div>
                </div>
                <div class="dot-zone" onclick="tapZone(event, 1)" ontouchstart="handleTouch(event, 1)">
                    <div class="dots-display" id="zone-1">
                        <canvas class="zone-canvas" id="canvas-1"></canvas>
                    </div>
                </div>
                <div class="dot-zone" onclick="tapZone(event, 2)" ontouchstart="handleTouch(event, 2)">
                    <div class="dots-display" id="zone-2">
                        <canvas class="zone-canvas" id="canvas-2"></canvas>
                    </div>
                </div>
                <div class="dot-zone" onclick="tapZone(event, 3)" ontouchstart="handleTouch(event, 3)">
                    <div class="dots-display" id="zone-3">
                        <canvas class="zone-canvas" id="canvas-3"></canvas>
                    </div>
                </div>
            </div>
            
            <div style="padding: 16px 20px 20px 20px; text-align: center;">
                <p style="color: rgba(93,78,55,0.7); font-size: 14px; margin-bottom: 16px; line-height: 1.4;">
                    å„é ˜åŸŸã‚’å³ã‹ã‚‰å·¦ã«å‘ã‹ã£ã¦ã€æ€ã„ã®ã¾ã¾ã«è‡ªç”±ãªå€‹æ•°ã§ãƒ‰ãƒƒãƒˆã‚’æ‰“ã£ã¦ãã ã•ã„ã€‚4ã¤ã®é ˜åŸŸã™ã¹ã¦ã«ãƒ‰ãƒƒãƒˆãŒé…ç½®ã•ã‚ŒãŸã‚‰ã€Œã‚·ãƒ³ãƒœãƒ«ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ãƒ‰ãƒƒãƒˆã®å¶æ•°ãƒ»å¥‡æ•°ã®çµ„ã¿åˆã‚ã›ã‹ã‚‰ã‚¸ã‚ªãƒãƒ³ã‚·ãƒ¼ã®ã‚·ãƒ³ãƒœãƒ«ãŒæ±ºã¾ã‚Šã¾ã™ã€‚
                </p>
                <button class="generate-button" id="generate-btn" onclick="generateSymbol()">
                    ã‚·ãƒ³ãƒœãƒ«ã‚’ç”Ÿæˆ
                </button>
            </div>
        </div>

        <!-- ãƒ€ã‚¤ã‚¹ã‚ªãƒ©ã‚¯ãƒ«ç”»é¢ -->
        <div id="dice-oracle-screen" class="screen">
            <div style="padding: 16px 0 8px 0;">
                <button class="back-button" style="margin-left: 20px;" onclick="showHome()">â† æˆ»ã‚‹</button>
            </div>
            
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div id="dice-container" style="flex: 1; min-height: 400px; position: relative; background: rgba(255,255,255,0.3); margin: 0 20px; border-radius: 12px;">
                    <!-- Three.jsã‚­ãƒ£ãƒ³ãƒã‚¹ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                </div>
                
                <div style="padding: 16px 20px 20px 20px; text-align: center;">
                    <p style="color: rgba(93,78,55,0.7); font-size: 14px; margin-bottom: 16px; line-height: 1.4;">
                        4ã¤ã®ãƒ€ã‚¤ã‚¹ï¼ˆç«ãƒ»é¢¨ãƒ»æ°´ãƒ»åœ°ï¼‰ã‚’æŒ¯ã£ã¦ã€å„è¦ç´ ã®å¶æ•°ãƒ»å¥‡æ•°ã®çµ„ã¿åˆã‚ã›ã‹ã‚‰ã‚¸ã‚ªãƒãƒ³ã‚·ãƒ¼ã®ã‚·ãƒ³ãƒœãƒ«ãŒæ±ºã¾ã‚Šã¾ã™ã€‚
                    </p>
                    <button class="roll-button" id="dice-roll-btn" onclick="rollPhysicalDice()">ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚·ãƒ³ãƒœãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="symbol-dialog" id="symbolDialog">
        <div class="symbol-content">
            <div class="symbol-header">
                <h3>å ã„çµæœ</h3>
                <button class="close-button" onclick="closeSymbolDialog()">Ã—</button>
            </div>
            
            <div class="symbol-body">
                <div class="symbol-image-area">
                    <div class="symbol-placeholder" id="symbol-image">
                        â€¢<br>â€¢â€¢<br>â€¢<br>â€¢â€¢
                    </div>
                </div>
                
                <div class="symbol-name" id="symbol-name">
                    ãƒ•ã‚©ãƒ«ãƒˆã‚¥ãƒŠãƒ»ãƒã‚¤ãƒŠãƒ¼ï¼ˆFortuna Minorï¼‰
                </div>
                
                <div class="symbol-meaning" id="symbol-meaning">
                    å°ã•ãªå¹¸é‹ãƒ»å†…ãªã‚‹åŠ›ã€‚è‡ªåˆ†è‡ªèº«ã®åŠ›ã§é“ã‚’åˆ‡ã‚Šé–‹ãæ™‚æœŸã§ã™ã€‚å›°é›£ãªçŠ¶æ³ã§ã‚‚ã€ã‚ãªãŸã®å†…ã«ç§˜ã‚ã‚‰ã‚ŒãŸåŠ›ã¨æ„å¿—ã®å¼·ã•ãŒé“ã‚’ç…§ã‚‰ã—ã¾ã™ã€‚
                </div>
            </div>
        </div>
    </div>

    <!-- Three.js ã¨ Cannon.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/1.15.1/cannon.min.js"></script>

    <script>
        // PWAç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ²
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsKICBldmVudC5yZXNwb25kV2l0aChmZXRjaChldmVudC5yZXF1ZXN0KSk7Cn0pOw==')
                .then(() => console.log('SW registered'))
                .catch(() => console.log('SW registration failed'));
            });
        }

        // ãƒ‰ãƒƒãƒˆå ã„ç”¨ã®å¤‰æ•°
        let zoneDots = [[], [], [], []]; // 4ã¤ã®é ˜åŸŸã®ãƒ‰ãƒƒãƒˆåº§æ¨™
        let isGenerating = false; // ç”Ÿæˆä¸­ãƒ•ãƒ©ã‚°

        // 3Dãƒ€ã‚¤ã‚¹ç”¨ã®å¤‰æ•°
        let scene, camera, renderer, world;
        let dicePhysics = [];
        let diceVisual = [];
        let isRolling = false;
        let diceResults = [null, null, null, null];

        // ãƒ€ã‚¤ã‚¹ã®è‰²ï¼ˆç«ãƒ»é¢¨ãƒ»æ°´ãƒ»åœ°ï¼‰
        const diceColors = [
            0xff4444, // ç«ï¼ˆèµ¤ï¼‰
            0xffff44, // é¢¨ï¼ˆé»„ï¼‰
            0x4444ff, // æ°´ï¼ˆé’ï¼‰
            0x44ff44  // åœ°ï¼ˆç·‘ï¼‰
        ];

        // ã‚¸ã‚ªãƒãƒ³ã‚·ãƒ¼ã®ã‚·ãƒ³ãƒœãƒ«å®šç¾©ï¼ˆ16ç¨®é¡ï¼‰
        const geomancySymbols = {
            '1111': { name: 'ãƒ´ã‚£ã‚¢ï¼ˆViaï¼‰', meaning: 'é“ãƒ»æ—…ãƒ»å¤‰åŒ–ã¸ã®å°ãã€‚æ–°ã—ã„å§‹ã¾ã‚Šã¨å‰é€²ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚', symbol: 'â€¢\nâ€¢\nâ€¢\nâ€¢' },
            '2222': { name: 'ãƒãƒ—ãƒ«ã‚¹ï¼ˆPopulusï¼‰', meaning: 'äººã€…ãƒ»é›†å›£ãƒ»ç¤¾ä¼šã¨ã®èª¿å’Œã€‚å‘¨å›²ã¨ã®é–¢ä¿‚æ€§ã‚’å¤§åˆ‡ã«ã™ã‚‹æ™‚æœŸã§ã™ã€‚', symbol: 'â€¢â€¢\nâ€¢â€¢\nâ€¢â€¢\nâ€¢â€¢' },
            '1122': { name: 'ã‚³ãƒ‹ãƒ¥ãƒ³ã‚¯ãƒ†ã‚£ã‚ªï¼ˆConiunctioï¼‰', meaning: 'çµåˆãƒ»èª¿å’Œãƒ»çµ±ä¸€ã€‚å¯¾ç«‹ã—ã¦ã„ãŸã‚‚ã®ãŒä¸€ã¤ã«ãªã‚‹å…†ã—ã§ã™ã€‚', symbol: 'â€¢\nâ€¢\nâ€¢â€¢\nâ€¢â€¢' },
            '2211': { name: 'ã‚«ãƒ«ã‚µãƒ¼ï¼ˆCarcerï¼‰', meaning: 'ç›£ç„ãƒ»åˆ¶é™ãƒ»æŸç¸›ã€‚ä¸€æ™‚çš„ãªåˆ¶é™ã®ä¸­ã§å†…é¢ã‚’è¦‹ã¤ã‚ã‚‹æ™‚ã§ã™ã€‚', symbol: 'â€¢â€¢\nâ€¢â€¢\nâ€¢\nâ€¢' },
            '1212': { name: 'ãƒ•ã‚©ãƒ«ãƒˆã‚¥ãƒŠãƒ»ãƒã‚¤ãƒŠãƒ¼ï¼ˆFortuna Minorï¼‰', meaning: 'å°ã•ãªå¹¸é‹ãƒ»å†…ãªã‚‹åŠ›ã€‚è‡ªåˆ†è‡ªèº«ã®åŠ›ã§é“ã‚’åˆ‡ã‚Šé–‹ãæ™‚æœŸã§ã™ã€‚', symbol: 'â€¢\nâ€¢â€¢\nâ€¢\nâ€¢â€¢' },
            '2121': { name: 'ãƒ•ã‚©ãƒ«ãƒˆã‚¥ãƒŠãƒ»ãƒã‚¤ãƒ¦ãƒ¼ãƒ«ï¼ˆFortuna Maiorï¼‰', meaning: 'å¤§ããªå¹¸é‹ãƒ»å¤–ãªã‚‹åŠ›ã€‚å¤–éƒ¨ã‹ã‚‰ã®æ”¯æ´ã‚„å¥½æ©ŸãŒè¨ªã‚Œã¾ã™ã€‚', symbol: 'â€¢â€¢\nâ€¢\nâ€¢â€¢\nâ€¢' },
            '1221': { name: 'ãƒ©ã‚¨ãƒ†ã‚£ã‚·ã‚¢ï¼ˆLaetitiaï¼‰', meaning: 'å–œã³ãƒ»æ¥½ã—ã•ãƒ»æº€è¶³ã€‚å¿ƒã®å¹³å®‰ã¨å……å®Ÿæ„Ÿã«æº€ãŸã•ã‚Œã‚‹æ™‚ã§ã™ã€‚', symbol: 'â€¢\nâ€¢â€¢\nâ€¢â€¢\nâ€¢' },
            '2112': { name: 'ãƒˆãƒªã‚¹ãƒ†ã‚£ã‚·ã‚¢ï¼ˆTristitiaï¼‰', meaning: 'æ‚²ã—ã¿ãƒ»æ†‚é¬±ãƒ»å›°é›£ã€‚è©¦ç·´ã‚’é€šã˜ã¦æˆé•·ã™ã‚‹å¤§åˆ‡ãªå­¦ã³ã®æ™‚æœŸã§ã™ã€‚', symbol: 'â€¢â€¢\nâ€¢\nâ€¢\nâ€¢â€¢' },
            '1211': { name: 'ã‚«ãƒ—ãƒˆãƒ»ãƒ‰ãƒ©ã‚³ãƒ‹ã‚¹ï¼ˆCaput Draconisï¼‰', meaning: 'é¾ã®é ­ãƒ»å§‹ã¾ã‚Šãƒ»å…¥å£ã€‚æ–°ãŸãªã‚µã‚¤ã‚¯ãƒ«ã®å§‹ã¾ã‚Šã‚’å‘Šã’ã¦ã„ã¾ã™ã€‚', symbol: 'â€¢\nâ€¢â€¢\nâ€¢\nâ€¢' },
            '2122': { name: 'ã‚«ã‚¦ãƒ€ãƒ»ãƒ‰ãƒ©ã‚³ãƒ‹ã‚¹ï¼ˆCauda Draconisï¼‰', meaning: 'é¾ã®å°»å°¾ãƒ»çµ‚ã‚ã‚Šãƒ»å‡ºå£ã€‚ä¸€ã¤ã®æ®µéšã®å®Œäº†ã¨æ¬¡ã¸ã®ç§»è¡Œã®æ™‚ã§ã™ã€‚', symbol: 'â€¢â€¢\nâ€¢\nâ€¢â€¢\nâ€¢â€¢' },
            '1112': { name: 'ãƒ”ãƒ¥ãƒ¼ã‚¨ãƒ«ï¼ˆPuerï¼‰', meaning: 'å°‘å¹´ãƒ»è¡å‹•ãƒ»è¡Œå‹•ã€‚æƒ…ç†±çš„ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã§ç©æ¥µçš„ã«è¡Œå‹•ã™ã‚‹æ™‚ã§ã™ã€‚', symbol: 'â€¢\nâ€¢\nâ€¢\nâ€¢â€¢' },
            '2221': { name: 'ãƒ—ã‚¨ãƒ©ï¼ˆPuellaï¼‰', meaning: 'å°‘å¥³ãƒ»å—å®¹ãƒ»ç¾ã€‚å„ªé›…ã•ã¨å—å®¹æ€§ã§ç‰©äº‹ã‚’è¿ãˆå…¥ã‚Œã‚‹æ™‚ã§ã™ã€‚', symbol: 'â€¢â€¢\nâ€¢â€¢\nâ€¢â€¢\nâ€¢' },
            '2111': { name: 'ã‚¢ãƒŸãƒƒã‚·ã‚ªï¼ˆAmissioï¼‰', meaning: 'å¤±ã†ã‚‚ã®ãƒ»æå¤±ãƒ»æ‰‹æ”¾ã—ã€‚æ‰‹æ”¾ã™ã“ã¨ã§æ–°ã—ã„å¯èƒ½æ€§ãŒç”Ÿã¾ã‚Œã¾ã™ã€‚', symbol: 'â€¢â€¢\nâ€¢\nâ€¢\nâ€¢' },
            '1222': { name: 'ã‚¢ã‚¯ã‚¤ã‚¸ãƒ†ã‚£ã‚ªï¼ˆAcquisitioï¼‰', meaning: 'å¾—ã‚‹ã‚‚ã®ãƒ»ç²å¾—ãƒ»å—ã‘å–ã‚Šã€‚åŠªåŠ›ã®æˆæœã‚„æ–°ã—ã„æµã¿ã‚’å—ã‘å–ã‚‹æ™‚ã§ã™ã€‚', symbol: 'â€¢\nâ€¢â€¢\nâ€¢â€¢\nâ€¢â€¢' },
            '2211': { name: 'ãƒ«ãƒ™ã‚¦ã‚¹ï¼ˆRubeusï¼‰', meaning: 'èµ¤ãƒ»æƒ…ç†±ãƒ»å±é™ºã€‚å¼·ã„æ„Ÿæƒ…ã«æ³¨æ„æ·±ãå‘ãåˆã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚', symbol: 'â€¢â€¢\nâ€¢â€¢\nâ€¢\nâ€¢' },
            '1122': { name: 'ã‚¢ãƒ«ãƒ–ã‚¹ï¼ˆAlbusï¼‰', meaning: 'ç™½ãƒ»ç´”ç²‹ãƒ»å¹³å’Œã€‚æ¸…ã‚‰ã‹ãªå¿ƒã§ç‰©äº‹ã‚’è¦‹ã¤ã‚ç›´ã™æ™‚æœŸã§ã™ã€‚', symbol: 'â€¢\nâ€¢\nâ€¢â€¢\nâ€¢â€¢' }
        };

        function showDotOracle() {
            hideAllScreens();
            document.getElementById('dot-oracle-screen').classList.add('active');
            resetDotOracle();
        }

        function showDiceOracle() {
            hideAllScreens();
            document.getElementById('dice-oracle-screen').classList.add('active');
            setTimeout(() => {
                initDiceScene();
            }, 100);
        }

        function showHome() {
            hideAllScreens();
            document.getElementById('home-screen').classList.add('active');
        }

        function hideAllScreens() {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.remove('active'));
        }

        function resetDotOracle() {
            zoneDots = [[], [], [], []];
            for (let i = 0; i < 4; i++) {
                const zoneElement = document.getElementById(`zone-${i}`);
                // ãƒ‰ãƒƒãƒˆã‚’å‰Šé™¤
                const dots = zoneElement.querySelectorAll('.dot');
                dots.forEach(dot => dot.remove());
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
                const canvas = document.getElementById(`canvas-${i}`);
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            updateGenerateButton();
        }

        function tapZone(event, zoneIndex) {
            event.preventDefault();
            event.stopPropagation();
            
            const zoneElement = document.getElementById(`zone-${zoneIndex}`);
            const rect = zoneElement.getBoundingClientRect();
            
            // ã‚¿ãƒƒãƒ—åº§æ¨™ã‚’å–å¾—ï¼ˆé ˜åŸŸå†…ã®ç›¸å¯¾åº§æ¨™ï¼‰
            const x = ((event.clientX - rect.left) / rect.width) * 100;
            const y = ((event.clientY - rect.top) / rect.height) * 100;
            
            addDot(zoneIndex, x, y);
        }

        function handleTouch(event, zoneIndex) {
            event.preventDefault();
            event.stopPropagation();
            
            if (event.touches && event.touches.length > 0) {
                const touch = event.touches[0];
                const zoneElement = document.getElementById(`zone-${zoneIndex}`);
                const rect = zoneElement.getBoundingClientRect();
                
                // ã‚¿ãƒƒãƒåº§æ¨™ã‚’å–å¾—ï¼ˆé ˜åŸŸå†…ã®ç›¸å¯¾åº§æ¨™ï¼‰
                const x = ((touch.clientX - rect.left) / rect.width) * 100;
                const y = ((touch.clientY - rect.top) / rect.height) * 100;
                
                addDot(zoneIndex, x, y);
            }
        }

        function addDot(zoneIndex, x, y) {
            // ç”Ÿæˆä¸­ã¯æ–°ã—ã„ãƒ‰ãƒƒãƒˆã‚’è¿½åŠ ã—ãªã„
            if (isGenerating) return;
            
            // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
            if (x < 0 || x > 100 || y < 0 || y > 100) return;
            
            // ãƒ‰ãƒƒãƒˆåº§æ¨™ã‚’ä¿å­˜
            zoneDots[zoneIndex].push({ x, y });
            
            // ãƒ‰ãƒƒãƒˆã‚’è¡¨ç¤º
            const zoneElement = document.getElementById(`zone-${zoneIndex}`);
            const dot = document.createElement('div');
            dot.className = 'dot';
            dot.style.left = `${x}%`;
            dot.style.top = `${y}%`;
            zoneElement.appendChild(dot);
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’æ›´æ–°
            const canvas = document.getElementById(`canvas-${zoneIndex}`);
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            updateGenerateButton();
        }

        function updateGenerateButton() {
            if (isGenerating) return;
            
            const generateBtn = document.getElementById('generate-btn');
            const allZonesHaveDots = zoneDots.every(zone => zone.length > 0);
            
            if (allZonesHaveDots) {
                generateBtn.classList.add('active');
            } else {
                generateBtn.classList.remove('active');
            }
        }

        function generateSymbol() {
            const generateBtn = document.getElementById('generate-btn');
            if (!generateBtn.classList.contains('active') || isGenerating) return;
            
            // å³åº§ã«ã‚¿ãƒƒãƒ—å‡¦ç†ã‚’ç„¡åŠ¹åŒ–
            isGenerating = true;
            generateBtn.classList.remove('active');
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';
            
            // å„ã‚¾ãƒ¼ãƒ³ã®ãƒ‰ãƒƒãƒˆã‚’ãƒšã‚¢ãƒªãƒ³ã‚°
            for (let i = 0; i < 4; i++) {
                animatePairing(i);
            }
            
            // ç·šãŒå¼•ã‹ã‚Œã¦ã‹ã‚‰é–“ã‚’ç½®ã„ã¦ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
            setTimeout(() => {
                showSymbolDialog();
            }, 2000);
        }

        function showSymbolDialog() {
            // å„ã‚¾ãƒ¼ãƒ³ã®å¶å¥‡ã‚’è¨ˆç®—
            const pattern = zoneDots.map(zone => {
                return zone.length % 2 === 0 ? '2' : '1';
            }).join('');
            
            // ã‚·ãƒ³ãƒœãƒ«ã‚’å–å¾—
            let symbol = geomancySymbols[pattern];
            if (!symbol) {
                const keys = Object.keys(geomancySymbols);
                symbol = geomancySymbols[keys[0]];
            }
            
            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å†…å®¹ã‚’æ›´æ–°
            document.getElementById('symbol-image').innerHTML = symbol.symbol.replace(/\n/g, '<br>');
            document.getElementById('symbol-name').textContent = symbol.name;
            document.getElementById('symbol-meaning').textContent = symbol.meaning;
            
            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
            document.getElementById('symbolDialog').classList.add('show');
        }

        function closeSymbolDialog() {
            document.getElementById('symbolDialog').classList.remove('show');
            
            // ãƒªã‚»ãƒƒãƒˆ
            setTimeout(() => {
                resetDotOracle();
                isGenerating = false;
                document.getElementById('generate-btn').textContent = 'ã‚·ãƒ³ãƒœãƒ«ã‚’ç”Ÿæˆ';
            }, 300);
        }

        // åˆæœŸåŒ–æ™‚ã«è¿½åŠ ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ã‚¯ãƒªãƒƒã‚¯å¤–ã§é–‰ã˜ã‚‹
            document.getElementById('symbolDialog').addEventListener('click', (e) => {
                if (e.target.id === 'symbolDialog') {
                    closeSymbolDialog();
                }
            });

            // ESCã‚­ãƒ¼ã§ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (document.getElementById('symbolDialog').classList.contains('show')) {
                        closeSymbolDialog();
                    }
                }
            });
        });

        function animatePairing(zoneIndex) {
            const zoneElement = document.getElementById(`zone-${zoneIndex}`);
            const canvas = document.getElementById(`canvas-${zoneIndex}`);
            const ctx = canvas.getContext('2d');
            const dots = zoneElement.querySelectorAll('.dot');
            const dotCoords = zoneDots[zoneIndex];
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // ãƒ‰ãƒƒãƒˆã‚’2ã¤ãšã¤ãƒšã‚¢ã«ã™ã‚‹
            for (let i = 0; i < dots.length; i += 2) {
                setTimeout(() => {
                    if (i + 1 < dots.length) {
                        // ãƒšã‚¢ï¼ˆãƒ‰ãƒƒãƒˆã®è‰²ã¯å¤‰æ›´ã—ãªã„ï¼‰
                        
                        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã§ç·šã‚’æç”»
                        const x1 = (dotCoords[i].x / 100) * canvas.width;
                        const y1 = (dotCoords[i].y / 100) * canvas.height;
                        const x2 = (dotCoords[i + 1].x / 100) * canvas.width;
                        const y2 = (dotCoords[i + 1].y / 100) * canvas.height;
                        
                        ctx.strokeStyle = '#8b7355';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.stroke();
                    } else {
                        // ä½™ã‚Šã®1ã¤ï¼ˆè‰²ã¯å¤‰æ›´ã—ãªã„ï¼‰
                    }
                }, i * 100);
            }
        }

        function resetDiceOracle() {
            diceResults = [null, null, null, null];
            isRolling = false;
            const rollBtn = document.getElementById('dice-roll-btn');
            if (rollBtn) {
                rollBtn.disabled = false;
                rollBtn.textContent = 'ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹';
            }
        }

        function initDiceScene() {
            const container = document.getElementById('dice-container');
            if (!container || container.querySelector('canvas')) return;

            const width = container.clientWidth;
            const height = container.clientHeight;

            // Three.js ã‚·ãƒ¼ãƒ³è¨­å®š
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf5f0e8);

            // ã‚«ãƒ¡ãƒ©ï¼ˆä¸Šã‹ã‚‰è¦‹ä¸‹ã‚ã™è¦–ç‚¹ï¼‰
            camera = new THREE.OrthographicCamera(
                width / -100, width / 100,
                height / 100, height / -100,
                0.1, 1000
            );
            camera.position.set(0, 10, 0);
            camera.lookAt(0, 0, 0);

            // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.domElement.id = 'dice-canvas';
            container.appendChild(renderer.domElement);

            // ãƒ©ã‚¤ãƒˆ
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³
            world = new CANNON.World();
            world.gravity.set(0, -30, 0);
            world.broadphase = new CANNON.NaiveBroadphase();

            // åºŠ
            const floorShape = new CANNON.Plane();
            const floorBody = new CANNON.Body({ mass: 0 });
            floorBody.addShape(floorShape);
            floorBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
            world.add(floorBody);

            // åºŠã®è¦–è¦šçš„è¡¨ç¾
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshLambertMaterial({ color: 0xe8dcc6, transparent: true, opacity: 0.8 });
            const floorMesh = new THREE.Mesh(floorGeometry, floorMaterial);
            floorMesh.rotation.x = -Math.PI / 2;
            floorMesh.receiveShadow = true;
            scene.add(floorMesh);

            // å£ï¼ˆãƒ€ã‚¤ã‚¹ãŒå¤–ã«å‡ºãªã„ã‚ˆã†ã«ï¼‰
            createWalls();

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
            animate();
        }

        function createWalls() {
            const wallDistance = 8;
            const wallHeight = 5;
            
            // 4ã¤ã®å£ã‚’ä½œæˆ
            const walls = [
                { pos: [wallDistance, wallHeight/2, 0], rot: [0, 0, 0] }, // å³
                { pos: [-wallDistance, wallHeight/2, 0], rot: [0, 0, 0] }, // å·¦
                { pos: [0, wallHeight/2, wallDistance], rot: [0, 0, 0] }, // å¥¥
                { pos: [0, wallHeight/2, -wallDistance], rot: [0, 0, 0] } // æ‰‹å‰
            ];

            walls.forEach(wall => {
                const wallShape = new CANNON.Box(new CANNON.Vec3(0.5, wallHeight/2, wallDistance));
                const wallBody = new CANNON.Body({ mass: 0 });
                wallBody.addShape(wallShape);
                wallBody.position.set(...wall.pos);
                world.add(wallBody);
            });
        }

        function createDice() {
            // æ—¢å­˜ã®ãƒ€ã‚¤ã‚¹ã‚’ã‚¯ãƒªã‚¢
            dicePhysics.forEach(dice => world.remove(dice));
            diceVisual.forEach(dice => scene.remove(dice));
            dicePhysics = [];
            diceVisual = [];

            for (let i = 0; i < 4; i++) {
                // ç‰©ç†ãƒ€ã‚¤ã‚¹
                const diceShape = new CANNON.Box(new CANNON.Vec3(0.5, 0.5, 0.5));
                const diceBody = new CANNON.Body({ mass: 1 });
                diceBody.addShape(diceShape);
                
                // åˆæœŸä½ç½®ï¼ˆå°‘ã—ãšã¤ãšã‚‰ã—ã¦é…ç½®ï¼‰
                diceBody.position.set(
                    (Math.random() - 0.5) * 4,
                    5 + i * 0.5,
                    (Math.random() - 0.5) * 4
                );
                
                // åˆæœŸå›è»¢ã¨é€Ÿåº¦
                diceBody.quaternion.set(
                    Math.random(), Math.random(), Math.random(), Math.random()
                ).normalize();
                
                diceBody.velocity.set(
                    (Math.random() - 0.5) * 10,
                    Math.random() * 5,
                    (Math.random() - 0.5) * 10
                );
                
                diceBody.angularVelocity.set(
                    (Math.random() - 0.5) * 20,
                    (Math.random() - 0.5) * 20,
                    (Math.random() - 0.5) * 20
                );

                // ãƒ€ã‚¤ã‚¹åŒå£«ã®è·³ã­è¿”ã‚Šä¿‚æ•°ã‚’å¤§ãã
                diceBody.material = new CANNON.Material();
                diceBody.material.restitution = 0.9;
                diceBody.material.friction = 0.3;

                world.add(diceBody);
                dicePhysics.push(diceBody);

                // è¦–è¦šçš„ãƒ€ã‚¤ã‚¹
                const diceGeometry = new THREE.BoxGeometry(1, 1, 1);
                const diceMaterial = new THREE.MeshLambertMaterial({ color: diceColors[i] });
                const diceMesh = new THREE.Mesh(diceGeometry, diceMaterial);
                diceMesh.castShadow = true;
                diceMesh.receiveShadow = true;
                scene.add(diceMesh);
                diceVisual.push(diceMesh);
            }

            // ãƒ€ã‚¤ã‚¹åŒå£«ã®è·³ã­è¿”ã‚Šè¨­å®š
            for (let i = 0; i < dicePhysics.length; i++) {
                for (let j = i + 1; j < dicePhysics.length; j++) {
                    const contactMaterial = new CANNON.ContactMaterial(
                        dicePhysics[i].material,
                        dicePhysics[j].material,
                        {
                            friction: 0.3,
                            restitution: 0.95 // éå¸¸ã«å¤§ããªè·³ã­è¿”ã‚Š
                        }
                    );
                    world.addContactMaterial(contactMaterial);
                }
            }
        }

        function rollPhysicalDice() {
            if (isRolling) return;
            
            isRolling = true;
            diceResults = [null, null, null, null];
            
            const rollBtn = document.getElementById('dice-roll-btn');
            rollBtn.disabled = true;
            rollBtn.textContent = 'æŒ¯ã£ã¦ã„ã¾ã™...';

            createDice();

            // 3ç§’å¾Œã«ãƒ€ã‚¤ã‚¹ãŒæ­¢ã¾ã£ãŸã‹ãƒã‚§ãƒƒã‚¯é–‹å§‹
            setTimeout(() => {
                checkDiceSettled();
            }, 3000);
        }

        function checkDiceSettled() {
            let allSettled = true;
            
            for (let i = 0; i < dicePhysics.length; i++) {
                const dice = dicePhysics[i];
                const velocity = dice.velocity.length();
                const angularVel = dice.angularVelocity.length();
                
                if (velocity > 0.1 || angularVel > 0.1) {
                    allSettled = false;
                    break;
                }
            }

            if (allSettled) {
                // ãƒ€ã‚¤ã‚¹ã®ç›®ã‚’åˆ¤å®š
                for (let i = 0; i < dicePhysics.length; i++) {
                    diceResults[i] = getDiceValue(dicePhysics[i]);
                }
                
                setTimeout(() => {
                    showDiceResults();
                }, 500);
            } else {
                // ã¾ã å‹•ã„ã¦ã„ã‚‹å ´åˆã¯å†ãƒã‚§ãƒƒã‚¯
                setTimeout(() => {
                    checkDiceSettled();
                }, 200);
            }
        }

        function getDiceValue(diceBody) {
            // ç°¡å˜ãªæ–¹æ³•ï¼šYè»¸ã®å‘ãã‹ã‚‰ä¸Šé¢ã‚’åˆ¤å®š
            const up = new CANNON.Vec3(0, 1, 0);
            const faces = [
                new CANNON.Vec3(0, 1, 0),  // ä¸Šé¢
                new CANNON.Vec3(0, -1, 0), // ä¸‹é¢
                new CANNON.Vec3(1, 0, 0),  // å³é¢
                new CANNON.Vec3(-1, 0, 0), // å·¦é¢
                new CANNON.Vec3(0, 0, 1),  // å‰é¢
                new CANNON.Vec3(0, 0, -1)  // å¾Œé¢
            ];

            let maxDot = -1;
            let topFace = 0;

            faces.forEach((face, index) => {
                const worldFace = diceBody.quaternion.vmult(face);
                const dot = worldFace.dot(up);
                if (dot > maxDot) {
                    maxDot = dot;
                    topFace = index;
                }
            });

            // é¢ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒ€ã‚¤ã‚¹ã®ç›®ã«å¤‰æ›ï¼ˆ1-6ï¼‰
            const faceValues = [1, 6, 2, 5, 3, 4];
            return faceValues[topFace];
        }

        function showDiceResults() {
            isRolling = false;
            
            // çµæœã‹ã‚‰ã‚¸ã‚ªãƒãƒ³ã‚·ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
            const pattern = diceResults.map(result => result % 2 === 0 ? '2' : '1').join('');
            
            // ã‚·ãƒ³ãƒœãƒ«ã‚’å–å¾—
            let symbol = geomancySymbols[pattern];
            if (!symbol) {
                const keys = Object.keys(geomancySymbols);
                symbol = geomancySymbols[keys[0]];
            }
            
            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å†…å®¹ã‚’æ›´æ–°
            document.getElementById('symbol-image').innerHTML = symbol.symbol.replace(/\n/g, '<br>');
            document.getElementById('symbol-name').textContent = symbol.name;
            document.getElementById('symbol-meaning').textContent = symbol.meaning;
            
            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
            document.getElementById('symbolDialog').classList.add('show');
            
            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            const rollBtn = document.getElementById('dice-roll-btn');
            rollBtn.disabled = false;
            rollBtn.textContent = 'ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹';
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (world) {
                world.step(1/60);
                
                // ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³ã®ä½ç½®ã‚’è¦–è¦šçš„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åæ˜ 
                for (let i = 0; i < dicePhysics.length; i++) {
                    if (diceVisual[i] && dicePhysics[i]) {
                        diceVisual[i].position.copy(dicePhysics[i].position);
                        diceVisual[i].quaternion.copy(dicePhysics[i].quaternion);
                    }
                }
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        function showAppPromo() {
            alert('Geomancy Diary ã‚¢ãƒ—ãƒªã®è©³ç´°ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™\nï¼ˆå®Ÿè£…äºˆå®šï¼‰');
        }

        // ã‚¿ãƒƒãƒæ“ä½œã®æ”¹å–„
        document.addEventListener('touchstart', function() {}, {passive: true});
    </script>
</body>
</html>
